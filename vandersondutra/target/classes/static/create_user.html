<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Criar Usuário</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
        .card { max-width: 480px; margin: 40px auto; border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
        label { display:block; margin-top: 12px; font-weight: 600; }
        input, select { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; }
        button { width: 100%; margin-top: 16px; padding: 12px; background:#1f6feb; color:white; border:0; border-radius: 6px; cursor:pointer; }
        .msg { margin-top: 12px; min-height: 20px; }
        .ok { color: #0a0; }
        .err { color: #c00; }
    </style>
    <script>
        const API_BASE = (location.protocol === 'file:') ? 'http://localhost:8080' : '';
        (function ensureAdmin() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            // Opcional: tentativa de acessar endpoint admin para validar role; em caso de 403 volta
            fetch(API_BASE + '/api/admin/ping', { headers: { 'Authorization': 'Bearer ' + token } })
                .then(r => { if (r.status === 403 || r.status === 401) { localStorage.removeItem('access_token'); window.location.href = 'login.html'; } })
                .catch(() => {});
        })();

        async function criar(ev) {
            ev.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const active = document.getElementById('active').checked;
            const msg = document.getElementById('msg');
            msg.className = 'msg'; msg.textContent = '';
            try {
                const token = localStorage.getItem('access_token');
                const res = await fetch(API_BASE + '/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ email, password, role, active })
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || ('HTTP ' + res.status));
                }
                const data = await res.json();
                msg.className = 'msg ok';
                msg.textContent = 'Usuário criado: ' + data.email + ' (' + data.role + ')';
                document.getElementById('form').reset();
            } catch (e) {
                msg.className = 'msg err';
                msg.textContent = e.message;
            }
        }
    </script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' http://localhost:8080; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';"/>
</head>
<body>
<div class="card">
    <h2>Criar Usuário</h2>
    <form id="form" onsubmit="criar(event)">
        <label for="email">Email</label>
        <input id="email" type="email" required placeholder="user@local"/>

        <label for="password">Senha</label>
        <input id="password" type="password" minlength="6" required />

        <label for="role">Role</label>
        <select id="role">
            <option value="USER">USER</option>
            <option value="ADMIN">ADMIN</option>
        </select>

        <label><input id="active" type="checkbox" checked /> Ativo</label>
        <button type="submit">Criar</button>
    </form>
    <div id="msg" class="msg"></div>
    <div style="margin-top:12px"><a href="client.html">Voltar</a></div>
    </div>
</body>
</html>


